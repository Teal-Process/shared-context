<head>

	<!-- TODO
	- on updateScroll, somehow get and update the mouse position, as it's moved down the page but hasn't fired the mousemove event 
	-->


	<!-- I believe this is being served up by the npm package automagically --> 
	<script src="/socket.io/socket.io.js"></script>
	<!--<script src="https://code.jquery.com/jquery-1.11.1.js"></script>-->
	<style>
		body {
			height: 200vh;
		}

		.scrollIndicator {
			height: 12px;
			width: 12px;
			background: white;
			position: fixed;
			border-radius: 24px;
			right: 16px;
			top: 0;
			margin: 0;
			border: 1px solid blue;
			transition: background 200ms ease-in-out;
		}

		.scrollIndicator:hover {
			background: blue;
			cursor: pointer;
		}

		.scrollIndicator--is-active {
			background: blue;
		}

		.scrollIndicator--is-active:hover {
			background: white;
		}

		.mouseIndicator {
			height: 16px;
			width: 16px;
			background: blue;
			opacity: 0.75;
			position: absolute;
			top: 0;
			left: 0;
			margin: 0;
		}

	</style>
</head>
<body>

	<p id='data'></p>
	<div id='friend-mouse' class='mouseIndicator'></div>
	<div id='friend-scroll' class='scrollIndicator'></div>

	<script>
	  (function() {
	   let socket = io();

	   let gather = new Gatherer(socket);
	   let presenter = new PresentMode();

		document.onscroll = function(e) {
			gather.updateScroll(e);
		}

		document.onmousemove = function(e) {
			gather.updateMouse(e);
		}

		let scrollId = 'friend-scroll';
		let friendScroll = document.getElementById(scrollId);
		friendScroll.addEventListener('click', function(e){
			presenter.toggleFollow(e.target.id);
		});

	    // whenever we receive mouse locations
	    socket.on('movement', function(data){
	    	console.log('notified of movement');
	    	let parsed = 'Another user: ' + data.mouse.x + ', ' + data.mouse.y;
	    	document.getElementById('data').innerText = parsed;

	    	document.getElementById('friend-mouse').style.top = data.mouse.y;
	    	document.getElementById('friend-mouse').style.left = data.mouse.x;

	    	presenter.setFriendScroll(data.scrollPercentage);
			let friendIndicator = data.scrollPercentage * window.innerHeight;
	    	document.getElementById('friend-scroll').style.top = friendIndicator;
	    });
	  })();

	  function helperToggleClass(id, activeClass){
	  	let el = document.getElementById(id);

		if (el.classList.contains(activeClass)) {		
			el.classList.remove(activeClass);
		} else {
			el.classList.add(activeClass);
		}
	  }

	  function PresentMode(){
	  	this.friendScrollPercentage = 0;
	  	this.following = false;

	  	// scroll to friend position and start following
	  	this.toggleFollow = function(indicatorId){
	  		let activeClass = 'scrollIndicator--is-active';
	  		helperToggleClass(indicatorId, activeClass);

	  		if(this.following){
	  			this.following = false;
	  		} else {
	  			this.scrollToFriend();
	  			this.following = true;
	  		}
	  	}

	  	this.setFriendScroll = function(percentage){
	  		this.friendScrollPercentage = percentage;
	  		if(this.following){
	  			this.scrollToFriend();
	  		}
	  	}

	  	this.scrollToFriend = function(){
	  		let scrollTop = this.friendScrollPercentage * getPageHeight();

	  		// on first click, smooth scroll, otherwise
	  		// we want to jump to each new scroll point
	  		let scrollBehavior;
	  		if(this.following) {
	  			scrollBehavior = 'auto';
	  		} else {
	  			scrollBehavior = 'smooth';
	  		}

	  		window.scrollTo({
			  top: scrollTop,
			  behavior: scrollBehavior
			});
	  	}
	  }

	  function Gatherer(socket){

		this.scrollY = 0;
		this.mouse = {
			x: 0,
			y: 0
		};

		this.updateScroll = function(e){
			this.scrollY = window.scrollY;
			this.sendData();
		}

		this.updateMouse = function(e){
			this.mouse.x = e.pageX;
			this.mouse.y = e.pageY;
			this.sendData();
		}

		this.sendData = function(){
			let view = {
				width: window.innerWidth,
				height: window.innerHeight
			};

			let pageHeight = getPageHeight();
			let scrollPercentage = this.scrollY / pageHeight;

			let data = {
				mouse: this.mouse,
				scrollPercentage: scrollPercentage,
				view: view
			};

			socket.emit('movement', data);
		}
	}

	  function getPageHeight(){
		let body = document.body,
			html = document.documentElement;

		let height = Math.max( body.scrollHeight, body.offsetHeight, 
		           html.clientHeight, html.scrollHeight, html.offsetHeight );

		return height;
	  }
	</script>





